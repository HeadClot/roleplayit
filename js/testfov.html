<html>
<body>
<div id="map"></div>
<script src="Shadowcast.js"></script>

<style>
body{line-height:0;font-size:0;}

.tile0,
.tile1,
.tile2,
.tile3 { width: 16px; height: 16px; float:left; }

.tile0 { background: #000 }
.tile1 { background: #333 }
.tile2 { background: #ddd }
.tile3 { background: #666 }

</style>

<script>

// Variables
var grid_size = 32;
var map = []; 
	while(map.push([]) < grid_size);	// prepare 2d map array
var player = { x: 7, y: 5 }; // starting coords
var range = 10;	// sight radius
var sight = []; // array with the fov

var world = {
	width: grid_size,
	height: grid_size,
	canSee: function( coord ) {
		try {
		return map[coord.x][coord.y] === 0;
		}
		catch (e) { return; false; }
	}
}


// Draw the map
function initMap() {
	// initialize map array
	for (var i=0; i< grid_size; i++) {
		for (var j=0; j< grid_size; j++) {
		
			map[i][j] = 0;
		}
	}
	world.width = grid_size;
	world.height = grid_size;
	
	// walls
	map[9][2] = 1;
	map[5][9] = 1;
	map[14][22] = 1;
	map[4][22] = 1;
	map[4][23] = 1;
	map[27][13] = 1;
	

	for (i=0;i<7;i++) {
		map[12][12+i] = 1;
		map[12+i][12] = 1;
		map[18-i][18] = 1;
		map[18][18-i] = 1;
		
		map[30][5+i] = 1;
		map[28][5+i] = 1;
	}
	map[15][18] = 0;

}

// Draws the fov over the map, ugly I know, but it's just for testing
function applyFOV() {
	for (var i=0; i< sight.length; i++) {
		//console.log( [sight[i].x, sight[i].y ]);
		var x = sight[i].x;
		var y = sight[i].y;
		if (x<0 || y<0 || x >= world.width || y >= world.height ) continue;
		
		 if (map[x][y] === 0) map[x][y] = 3; // gray ground
		 if (map[x][y] === 1) map[x][y] = 2; // highlight wall
		// map[x][y] = 2;
		
	}
}

// Display as DOM
function renderMap() {
	var mapDOM = document.getElementById('map');
	var elements = ''
	for (var i=0; i< world.width; i++) {
		for (var j=0; j< world.height; j++) {
			elements += '<div class="tile' + map[j][i] + '"></div>';
		}
		elements += '<br clear="all" />';
	}
	mapDOM.innerHTML = elements;
}

// Redraw the screen
function refresh() {
	initMap();
	sight = Shadowcast.calcFoV(world, player.x, player.y, range);
	applyFOV();
	renderMap();
}
/**********************************************************************/

// Begin
refresh();

// Keyboard handler
document.onkeydown = function(e) {
	var e = e || window.event;
	var key=e.keyCode? e.keyCode : e.charCode;

	switch(key) {
		case 37: // left
			player.x--;
			break;
		case 38: // up
			player.y--;
			break;
		case 39: // right
			player.x++;
			break;
		case 40:
			player.y++;
			break;
	}
	
	refresh();
};

</script>
</body>
</html>

